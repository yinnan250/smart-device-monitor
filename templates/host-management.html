<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主机管理 - 服务器监控系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">服务器实时监控数据大屏系统</h1>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="nav-link">监控大屏</a>
                <a href="{{ url_for('host_management') }}" class="nav-link active">主机管理</a>
                <a href="{{ url_for('data_history') }}" class="nav-link">历史数据</a>
            </div>
        </div>
    </nav>

    <!-- 主机管理内容 -->
    <div class="management-container">
        <h2>主机管理</h2>
        
        <!-- 添加主机表单 -->
        <div class="form-section">
            <h3>添加新主机</h3>
            <form id="addHostForm" class="host-form">
                <div class="form-group">
                    <label for="hostIp">主机IP地址 *</label>
                    <input type="text" id="hostIp" name="hostIp" required 
                           placeholder="例如：192.168.1.100">
                </div>
                
                <div class="form-group">
                    <label for="sshUser">SSH用户名 *</label>
                    <input type="text" id="sshUser" name="sshUser" required 
                           placeholder="例如：root">
                </div>
                
                <div class="form-group">
                    <label for="sshPassword">SSH密码 *</label>
                    <input type="password" id="sshPassword" name="sshPassword" required 
                           placeholder="请输入SSH密码">
                </div>
                
                <div class="form-group">
                    <label for="sshPort">SSH端口</label>
                    <input type="number" id="sshPort" name="sshPort" value="22" 
                           placeholder="默认22" min="1" max="65535">
                </div>
                
                <div class="form-actions">
                    <button type="button" id="testSshBtn" class="btn-secondary">测试SSH连接</button>
                    <button type="submit" class="btn-primary">添加主机</button>
                </div>
                
                <div id="sshTestResult" class="test-result"></div>
            </form>
        </div>

        <!-- 主机列表 -->
        <div class="hosts-section">
            <h3>已监控的主机列表</h3>
            <div id="hostsList" class="hosts-list">
                <div class="empty-state">暂无监控主机，请先添加主机。</div>
            </div>
        </div>
    </div>

    <script>
        // MonitoringAPI类
        class MonitoringAPI {
            static BASE_URL = '/api';
            
            // 获取所有主机
            static async getHosts() {
                try {
                    const response = await fetch(`${this.BASE_URL}/hosts`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('获取主机列表失败:', error);
                    throw error;
                }
            }
            
            // 添加主机
            static async addHost(hostData) {
                try {
                    const response = await fetch(`${this.BASE_URL}/hosts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(hostData)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('添加主机失败:', error);
                    throw error;
                }
            }
            
            // 删除主机
            static async deleteHost(hostId) {
                try {
                    const response = await fetch(`${this.BASE_URL}/hosts/${hostId}`, { 
                        method: 'DELETE' 
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    console.error('删除主机失败:', error);
                    throw error;
                }
            }
            
            // 获取监控数据
            static async getMonitoringData() {
                try {
                    const response = await fetch(`${this.BASE_URL}/monitoring/data`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('获取监控数据失败:', error);
                    throw error;
                }
            }
            
            // 测试SSH连接
            static async testSshConnection(hostData) {
                try {
                    const response = await fetch(`${this.BASE_URL}/test-ssh`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(hostData)
                    });
                    return await response.json();
                } catch (error) {
                    console.error('SSH连接测试失败:', error);
                    return { success: false, message: '网络错误: ' + error.message };
                }
            }
        }

        // HostManager类
        class HostManager {
            constructor() {
                this.init();
            }
            
            async init() {
                if (document.getElementById('addHostForm')) {
                    this.setupHostForm();
                    await this.loadHostsList();
                }
            }
            
            setupHostForm() {
                const form = document.getElementById('addHostForm');
                form.addEventListener('submit', (e) => this.handleAddHost(e));
                
                // 添加SSH测试按钮事件
                document.getElementById('testSshBtn').addEventListener('click', () => this.testSshConnection());
            }
            
            async testSshConnection() {
                const form = document.getElementById('addHostForm');
                const formData = new FormData(form);
                const hostData = {
                    hostIp: formData.get('hostIp'),
                    sshUser: formData.get('sshUser'),
                    sshPassword: formData.get('sshPassword'),
                    sshPort: formData.get('sshPort') || '22'
                };
                
                // 验证IP地址
                if (!this.isValidIp(hostData.hostIp)) {
                    alert('请输入有效的IP地址');
                    return;
                }
                
                const resultDiv = document.getElementById('sshTestResult');
                resultDiv.innerHTML = '<div class="testing">正在测试SSH连接...</div>';
                
                try {
                    const result = await MonitoringAPI.testSshConnection(hostData);
                    
                    if (result.success) {
                        resultDiv.innerHTML = '<div class="success">✅ SSH连接测试成功！</div>';
                    } else {
                        resultDiv.innerHTML = `<div class="error">❌ SSH连接测试失败: ${result.message}</div>`;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error">❌ 测试过程中发生错误: ${error.message}</div>`;
                }
            }
            
            async handleAddHost(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const hostData = {
                    hostIp: formData.get('hostIp'),
                    sshUser: formData.get('sshUser'),
                    sshPassword: formData.get('sshPassword'),
                    sshPort: formData.get('sshPort') || '22'
                };
                
                // 验证IP地址
                if (!this.isValidIp(hostData.hostIp)) {
                    alert('请输入有效的IP地址');
                    return;
                }
                
                try {
                    await MonitoringAPI.addHost(hostData);
                    event.target.reset();
                    document.getElementById('sshTestResult').innerHTML = '';
                    await this.loadHostsList();
                    alert('主机添加成功！');
                } catch (error) {
                    alert('添加主机失败: ' + error.message);
                }
            }
            
            isValidIp(ip) {
                const pattern = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
                if (!pattern.test(ip)) return false;
                
                return ip.split('.').every(segment => {
                    const num = parseInt(segment);
                    return num >= 0 && num <= 255;
                });
            }
            
            async loadHostsList() {
                const hostsList = document.getElementById('hostsList');
                
                try {
                    const hosts = await MonitoringAPI.getHosts();
                    
                    if (hosts.length === 0) {
                        hostsList.innerHTML = '<div class="empty-state">暂无监控主机，请先添加主机。</div>';
                        return;
                    }
                    
                    hostsList.innerHTML = hosts.map(host => `
                        <div class="host-list-item">
                            <div class="host-info">
                                <div><strong>IP地址:</strong> ${host.hostIp}</div>
                                <div><strong>SSH用户:</strong> ${host.sshUser}</div>
                                <div><strong>SSH端口:</strong> ${host.sshPort}</div>
                                <div><strong>添加时间:</strong> ${new Date(host.createdAt).toLocaleString()}</div>
                            </div>
                            <button class="btn-danger" onclick="hostManager.deleteHost(${host.id})">删除</button>
                        </div>
                    `).join('');
                } catch (error) {
                    hostsList.innerHTML = '<div class="error">加载主机列表失败</div>';
                }
            }
            
            async deleteHost(hostId) {
                if (confirm('确定要删除这个主机吗？')) {
                    try {
                        await MonitoringAPI.deleteHost(hostId);
                        await this.loadHostsList();
                    } catch (error) {
                        alert('删除失败: ' + error.message);
                    }
                }
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            window.hostManager = new HostManager();
        });
    </script>
</body>
</html>